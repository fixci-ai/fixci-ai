<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixCI Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .auth-section {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        button.secondary {
            background: var(--bg-dark);
            border: 1px solid var(--border);
        }

        button.danger {
            background: var(--danger);
        }

        button.danger:hover {
            background: #dc2626;
        }

        .hidden {
            display: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg-dark);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.free {
            background: #334155;
            color: #94a3b8;
        }

        .badge.pro {
            background: #10b98133;
            color: var(--primary);
        }

        .badge.enterprise {
            background: #f59e0b33;
            color: var(--warning);
        }

        .badge.active {
            background: #10b98133;
            color: var(--primary);
        }

        .badge.suspended {
            background: #ef444433;
            color: var(--danger);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert.success {
            background: #10b98133;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .alert.error {
            background: #ef444433;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filters > * {
            flex: 1;
            min-width: 200px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        pre {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß FixCI Admin Dashboard</h1>
            <p style="color: var(--text-muted);">Manage subscriptions, view analytics, and control access</p>
        </header>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h2 style="margin-bottom: 1rem;">üîê Authentication</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Enter your admin API key and worker URL to access the dashboard</p>

            <div class="input-group">
                <label>Worker URL</label>
                <input type="text" id="workerUrl" placeholder="https://api.fixci.dev" value="https://api.fixci.dev">
            </div>

            <div class="input-group">
                <label>Admin API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your admin API key">
            </div>

            <button onclick="authenticate()">Connect to Dashboard</button>
        </div>

        <!-- Main Dashboard (hidden until authenticated) -->
        <div id="dashboard" class="hidden">
            <!-- Stats -->
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Total Installations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Pro Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Analyses (7 days)</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('subscriptions')">Subscriptions</button>
                <button class="tab" onclick="switchTab('grant')">Grant Access</button>
                <button class="tab" onclick="switchTab('actions')">Actions</button>
            </div>

            <!-- Tab: Subscriptions List -->
            <div id="tab-subscriptions" class="tab-content">
                <h2 style="margin-bottom: 1rem;">Subscriptions</h2>

                <div class="filters">
                    <div>
                        <label>Filter by Tier</label>
                        <select id="filterTier" onchange="loadSubscriptions()">
                            <option value="">All Tiers</option>
                            <option value="free">Free</option>
                            <option value="pro">Pro</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label>Filter by Status</label>
                        <select id="filterStatus" onchange="loadSubscriptions()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="loadSubscriptions()">Refresh</button>
                    </div>
                </div>

                <div id="subscriptionsList"></div>
            </div>

            <!-- Tab: Grant Access -->
            <div id="tab-grant" class="tab-content hidden">
                <h2 style="margin-bottom: 1rem;">Waitlist</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Users who signed up on the landing page</p>

                <div style="margin-bottom: 2rem;">
                    <table id="waitlistTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Repository</th>
                                <th>Signed Up</th>
                                <th>GitHub Account</th>
                                <th>Current Tier</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="waitlistBody">
                            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <hr style="margin: 2rem 0; border: 1px solid var(--border); opacity: 0.3;">

                <h2 style="margin-bottom: 1rem;">üîç Search Installations</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Find installations by GitHub account name or organization</p>

                <div class="filters" style="margin-bottom: 1rem;">
                    <div>
                        <label>Search by Name</label>
                        <input type="text" id="searchQuery" placeholder="e.g., fixci-ai, acme-corp" onkeyup="if(event.key==='Enter') searchInstallations()">
                    </div>
                    <div>
                        <label>Filter by Tier</label>
                        <select id="searchFilterTier" onchange="searchInstallations()">
                            <option value="">All Tiers</option>
                            <option value="free">Free</option>
                            <option value="pro">Pro</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label>Filter by Status</label>
                        <select id="searchFilterStatus" onchange="searchInstallations()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div class="button-group" style="margin-bottom: 1rem;">
                    <button onclick="searchInstallations()">Search</button>
                    <button onclick="loadAllInstallations()" style="background: var(--bg-card); color: var(--text);">Show All</button>
                </div>

                <div id="searchResults" style="margin-bottom: 2rem;"></div>

                <hr style="margin: 2rem 0; border: 1px solid var(--border); opacity: 0.3;">

                <h2 style="margin-bottom: 1rem;">Grant Subscription Tier</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Manually grant or change subscription tier for an installation</p>

                <div class="input-group">
                    <label>Email (from waitlist)</label>
                    <input type="email" id="grantEmail" placeholder="user@example.com">
                    <small style="color: var(--text-muted);">Or enter Installation ID below directly</small>
                </div>

                <div class="input-group">
                    <label>Installation ID</label>
                    <input type="number" id="grantInstallationId" placeholder="12345">
                </div>

                <div class="input-group">
                    <label>Repository URL</label>
                    <input type="text" id="grantRepository" placeholder="https://github.com/username/repo">
                    <small style="color: var(--text-muted);">The repository they want to monitor with FixCI</small>
                </div>

                <div class="input-group">
                    <label>Tier</label>
                    <select id="grantTier">
                        <option value="free">Free</option>
                        <option value="pro">Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Reason</label>
                    <textarea id="grantReason" rows="3" placeholder="e.g., Beta tester program, Partner agreement, etc."></textarea>
                </div>

                <button onclick="grantSubscription()">Grant Subscription</button>
            </div>

            <!-- Tab: Actions -->
            <div id="tab-actions" class="tab-content hidden">
                <h2 style="margin-bottom: 1rem;">Subscription Actions</h2>

                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Suspend/Activate Subscription</h3>
                    <div class="input-group">
                        <label>Installation ID</label>
                        <input type="number" id="statusInstallationId" placeholder="12345">
                    </div>
                    <div class="input-group">
                        <label>New Status</label>
                        <select id="newStatus">
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Reason</label>
                        <input type="text" id="statusReason" placeholder="e.g., Payment failed, ToS violation, etc.">
                    </div>
                    <button onclick="updateStatus()">Update Status</button>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Reset Usage</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">Reset usage counters for current billing period</p>
                    <div class="input-group">
                        <label>Installation ID</label>
                        <input type="number" id="resetInstallationId" placeholder="12345">
                    </div>
                    <div class="input-group">
                        <label>Reason</label>
                        <input type="text" id="resetReason" placeholder="e.g., Service credit, Testing, etc.">
                    </div>
                    <button onclick="resetUsage()">Reset Usage</button>
                </div>

                <div>
                    <h3 style="margin-bottom: 1rem; color: var(--danger);">üö´ Revoke/Downgrade Access</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">Downgrade to free tier or suspend account</p>
                    <div class="input-group">
                        <label>Installation ID</label>
                        <input type="number" id="revokeInstallationId" placeholder="12345">
                    </div>
                    <div class="input-group">
                        <label>Action</label>
                        <select id="revokeAction">
                            <option value="downgrade">Downgrade to Free Tier</option>
                            <option value="suspend">Suspend Account</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Reason</label>
                        <input type="text" id="revokeReason" placeholder="e.g., Payment failed, ToS violation, etc.">
                    </div>
                    <button onclick="revokeAccess()" style="background: var(--danger);">Revoke Access</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Subscription Details -->
    <div id="detailsModal" class="modal hidden">
        <div class="modal-content">
            <h2>Subscription Details</h2>
            <div id="detailsContent"></div>
            <div class="button-group">
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let API_KEY = '';
        let WORKER_URL = '';

        function authenticate() {
            API_KEY = document.getElementById('apiKey').value;
            WORKER_URL = document.getElementById('workerUrl').value;

            if (!API_KEY || !WORKER_URL) {
                alert('Please enter both Worker URL and API Key');
                return;
            }

            // Test connection
            fetchStats().then(() => {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadSubscriptions();
            }).catch(err => {
                alert('Authentication failed: ' + err.message);
            });
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${WORKER_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'API call failed');
            }

            return response.json();
        }

        async function fetchStats() {
            const data = await apiCall('/admin/stats');

            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${data.tiers.reduce((sum, t) => sum + t.count, 0)}</div>
                    <div class="stat-label">Total Installations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.tiers.find(t => t.tier === 'pro')?.count || 0}</div>
                    <div class="stat-label">Pro Subscribers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${data.revenue.total.toFixed(2)}</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.activity.analysesLast7Days}</div>
                    <div class="stat-label">Analyses (7 days)</div>
                </div>
            `;
        }

        async function loadSubscriptions() {
            const tier = document.getElementById('filterTier').value;
            const status = document.getElementById('filterStatus').value;

            let query = '/admin/subscriptions?limit=100';
            if (tier) query += `&tier=${tier}`;
            if (status) query += `&status=${status}`;

            const container = document.getElementById('subscriptionsList');
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const data = await apiCall(query);

                if (data.subscriptions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No subscriptions found</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Installation</th>
                                <th>Account</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Usage</th>
                                <th>Period</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.subscriptions.map(sub => `
                                <tr>
                                    <td>#${sub.installation_id}</td>
                                    <td>${sub.account_login || 'N/A'}</td>
                                    <td><span class="badge ${sub.tier}">${sub.tier}</span></td>
                                    <td><span class="badge ${sub.status}">${sub.status}</span></td>
                                    <td>${sub.analyses_used_current_period}/${sub.analyses_limit_monthly || '‚àû'}</td>
                                    <td>${sub.current_period_start} ‚Üí ${sub.current_period_end}</td>
                                    <td class="actions">
                                        <button class="btn-sm" onclick="viewDetails(${sub.installation_id})">View</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = `<div class="alert error">Error loading subscriptions: ${err.message}</div>`;
            }
        }

        async function viewDetails(installationId) {
            try {
                const data = await apiCall(`/admin/subscriptions/details?installation_id=${installationId}`);

                document.getElementById('detailsContent').innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Subscription</h3>
                        <pre>${JSON.stringify(data.subscription, null, 2)}</pre>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Installation</h3>
                        <pre>${JSON.stringify(data.installation, null, 2)}</pre>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 0.5rem;">Stats</h3>
                        <pre>${JSON.stringify(data.stats, null, 2)}</pre>
                    </div>
                `;

                document.getElementById('detailsModal').classList.remove('hidden');
            } catch (err) {
                alert('Error loading details: ' + err.message);
            }
        }

        async function grantSubscription() {
            const installationId = document.getElementById('grantInstallationId').value;
            const tier = document.getElementById('grantTier').value;
            const reason = document.getElementById('grantReason').value;
            const repository = document.getElementById('grantRepository').value;

            if (!installationId || !tier) {
                alert('Please fill in Installation ID and Tier');
                return;
            }

            if (!repository) {
                alert('Please specify the repository they want to monitor');
                return;
            }

            try {
                const result = await apiCall('/admin/subscriptions/grant', {
                    method: 'POST',
                    body: JSON.stringify({
                        installationId: parseInt(installationId),
                        tier,
                        reason: reason ? `${reason} | Repository: ${repository}` : `Repository: ${repository}`
                    })
                });

                alert(`Success: ${result.message}\n\nRepository: ${repository}\n\nNext steps:\n1. User needs to install GitHub App on their repository\n2. They can then start using FixCI`);
                document.getElementById('grantEmail').value = '';
                document.getElementById('grantInstallationId').value = '';
                document.getElementById('grantRepository').value = '';
                document.getElementById('grantReason').value = '';
                fetchStats();
                fetchWaitlist();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function updateStatus() {
            const installationId = document.getElementById('statusInstallationId').value;
            const status = document.getElementById('newStatus').value;
            const reason = document.getElementById('statusReason').value;

            if (!installationId || !status) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const result = await apiCall('/admin/subscriptions/status', {
                    method: 'POST',
                    body: JSON.stringify({ installationId: parseInt(installationId), status, reason })
                });

                alert(`Success: ${result.message}`);
                document.getElementById('statusInstallationId').value = '';
                document.getElementById('statusReason').value = '';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function resetUsage() {
            const installationId = document.getElementById('resetInstallationId').value;
            const reason = document.getElementById('resetReason').value;

            if (!installationId) {
                alert('Please enter installation ID');
                return;
            }

            try {
                const result = await apiCall('/admin/subscriptions/reset-usage', {
                    method: 'POST',
                    body: JSON.stringify({ installationId: parseInt(installationId), reason })
                });

                alert(`Success: ${result.message}`);
                document.getElementById('resetInstallationId').value = '';
                document.getElementById('resetReason').value = '';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadAllInstallations() {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="color: var(--text-muted);">Loading all installations...</p>';

            try {
                const data = await apiCall('/admin/subscriptions?limit=1000');

                if (!data.subscriptions || data.subscriptions.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: var(--text-muted);">No installations found</p>';
                    return;
                }

                // Apply filters
                let filtered = data.subscriptions;
                const tierFilter = document.getElementById('searchFilterTier').value;
                const statusFilter = document.getElementById('searchFilterStatus').value;
                const queryFilter = document.getElementById('searchQuery').value.toLowerCase();

                if (tierFilter) {
                    filtered = filtered.filter(inst => inst.tier === tierFilter);
                }
                if (statusFilter) {
                    filtered = filtered.filter(inst => inst.status === statusFilter);
                }
                if (queryFilter) {
                    filtered = filtered.filter(inst =>
                        inst.account_login.toLowerCase().includes(queryFilter)
                    );
                }

                displayInstallations(filtered, `Showing ${filtered.length} of ${data.subscriptions.length} installation(s)`);
            } catch (err) {
                resultsDiv.innerHTML = `<p style="color: var(--danger);">Error: ${err.message}</p>`;
            }
        }

        async function searchInstallations() {
            const query = document.getElementById('searchQuery').value;
            const tierFilter = document.getElementById('searchFilterTier').value;
            const statusFilter = document.getElementById('searchFilterStatus').value;

            // If no query and no filters, load all
            if ((!query || query.length < 2) && !tierFilter && !statusFilter) {
                loadAllInstallations();
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="color: var(--text-muted);">Searching...</p>';

            try {
                let url = '/admin/installations/search?';
                const params = [];

                if (query && query.length >= 2) {
                    params.push(`q=${encodeURIComponent(query)}`);
                }
                params.push('limit=100');

                const data = await apiCall(url + params.join('&'));

                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: var(--text-muted);">No installations found</p>';
                    return;
                }

                // Apply filters
                let filtered = data.results;
                if (tierFilter) {
                    filtered = filtered.filter(inst => inst.tier === tierFilter);
                }
                if (statusFilter) {
                    filtered = filtered.filter(inst => inst.subscription_status === statusFilter);
                }

                displayInstallations(filtered, `Found ${filtered.length} installation(s)`);
            } catch (err) {
                resultsDiv.innerHTML = `<p style="color: var(--danger);">Error: ${err.message}</p>`;
            }
        }

        function displayInstallations(installations, message) {
            const resultsDiv = document.getElementById('searchResults');

            if (!installations || installations.length === 0) {
                resultsDiv.innerHTML = '<p style="color: var(--text-muted);">No installations match the filters</p>';
                return;
            }

            const html = `
                <div style="background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">${message}</p>
                    ${installations.map(inst => `
                        <div onclick="fillInstallationId(${inst.installation_id}, '${inst.account_login}', ${inst.repository_count || 0})" style="
                            background: var(--bg-card);
                            border: 1px solid var(--border);
                            border-left: 3px solid var(--primary);
                            border-radius: 6px;
                            padding: 1rem;
                            margin-bottom: 0.75rem;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.borderLeftColor='#059669'" onmouseout="this.style.borderLeftColor='var(--primary)'">
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${inst.account_login}</h4>
                            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                <strong>Installation ID:</strong> ${inst.installation_id}
                            </p>
                            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                <strong>Tier:</strong> <span style="
                                    display: inline-block;
                                    padding: 0.15rem 0.5rem;
                                    background: ${inst.tier === 'pro' ? 'var(--primary)' : inst.tier === 'enterprise' ? '#8b5cf6' : 'var(--border)'};
                                    border-radius: 4px;
                                    font-size: 0.8rem;
                                ">${inst.tier || 'free'}</span>
                                <strong>Status:</strong> <span style="
                                    display: inline-block;
                                    padding: 0.15rem 0.5rem;
                                    background: ${(() => {
                                        const status = inst.subscription_status || inst.status;
                                        if (!status || status === 'active') return 'var(--primary)';
                                        if (status === 'suspended' || status === 'cancelled') return 'var(--danger)';
                                        return 'var(--warning)';
                                    })()};
                                    border-radius: 4px;
                                    font-size: 0.8rem;
                                ">${inst.subscription_status || inst.status || 'active'}</span>
                            </p>
                            <p style="font-size: 0.9rem; color: var(--text-muted);">
                                <strong>Usage:</strong> ${inst.analyses_used_current_period || 0}/${inst.analyses_limit_monthly || 0} analyses |
                                <strong>Repos:</strong> ${inst.repository_count || 0}
                            </p>
                            <p style="font-size: 0.85rem; color: var(--primary); margin-top: 0.5rem;">Click to auto-fill Installation ID ‚Üì</p>
                        </div>
                    `).join('')}
                </div>
            `;
            resultsDiv.innerHTML = html;
        }

        function fillInstallationId(id, accountLogin, repoCount) {
            // Fill all installation ID fields
            document.getElementById('grantInstallationId').value = id;
            document.getElementById('statusInstallationId').value = id;
            document.getElementById('resetInstallationId').value = id;
            document.getElementById('revokeInstallationId').value = id;

            // Clear repository field and add note (since installations can have multiple repos)
            const repoField = document.getElementById('grantRepository');
            if (repoField) {
                repoField.value = '';
                repoField.placeholder = `Installation has ${repoCount || 0} repo(s) - leave empty or specify one`;
            }

            // Clear email field (not applicable for existing installations)
            const emailField = document.getElementById('grantEmail');
            if (emailField) {
                emailField.value = '';
            }

            // Show success message
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 9999;';
            msg.textContent = `${accountLogin} (ID: ${id}) filled in all forms`;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2500);
        }

        async function revokeAccess() {
            const installationId = document.getElementById('revokeInstallationId').value;
            const action = document.getElementById('revokeAction').value;
            const reason = document.getElementById('revokeReason').value;

            if (!installationId) {
                alert('Please enter installation ID');
                return;
            }

            const confirmMsg = action === 'downgrade'
                ? `Are you sure you want to downgrade installation ${installationId} to free tier?`
                : `Are you sure you want to suspend installation ${installationId}?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const result = await apiCall('/admin/subscriptions/revoke', {
                    method: 'POST',
                    body: JSON.stringify({
                        installationId: parseInt(installationId),
                        action,
                        reason
                    })
                });

                alert(`Success: ${result.message}`);
                document.getElementById('revokeInstallationId').value = '';
                document.getElementById('revokeReason').value = '';
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function fetchWaitlist() {
            try {
                const data = await apiCall('/admin/waitlist');
                const tbody = document.getElementById('waitlistBody');

                if (data.waitlist.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No waitlist entries found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.waitlist.map(entry => {
                    const hasInstallation = entry.installation_id ? true : false;
                    const statusBadge = hasInstallation
                        ? `<span class="badge ${entry.status || 'active'}">${entry.tier || 'Free'} - ${entry.status || 'Active'}</span>`
                        : '<span class="badge" style="background: var(--text-muted);">Not installed</span>';

                    const repoShort = entry.repository
                        ? entry.repository.replace('https://github.com/', '').replace('.git', '')
                        : '-';

                    return `
                        <tr>
                            <td>${entry.email}</td>
                            <td style="font-family: monospace; font-size: 0.85rem;">${repoShort}</td>
                            <td>${new Date(entry.created_at).toLocaleDateString()}</td>
                            <td>${entry.account_login || '-'}</td>
                            <td>${entry.tier || '-'}</td>
                            <td>${statusBadge}</td>
                            <td class="actions">
                                ${hasInstallation
                                    ? `<button class="btn-sm" onclick="populateGrantForm('${entry.email}', ${entry.installation_id}, '${entry.tier || 'free'}', '${entry.repository || ''}')">Grant Access</button>`
                                    : `<button class="btn-sm" onclick="populateGrantForm('${entry.email}', null, 'free', '${entry.repository || ''}')">Manual Setup</button>`
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                document.getElementById('waitlistBody').innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--danger);">Error: ${err.message}</td></tr>`;
            }
        }

        function populateGrantForm(email, installationId, currentTier, repository) {
            document.getElementById('grantEmail').value = email;
            document.getElementById('grantRepository').value = repository || '';

            if (installationId) {
                document.getElementById('grantInstallationId').value = installationId;
            } else {
                document.getElementById('grantInstallationId').value = '';
                alert(`This user hasn't installed the GitHub App yet.\n\nEmail: ${email}\nRepository: ${repository}\n\nNext steps:\n1. Get their GitHub username\n2. Ask them to install FixCI GitHub App\n3. Come back here and enter their Installation ID`);
            }

            // Pre-select Pro tier for new grants
            document.getElementById('grantTier').value = currentTier === 'free' ? 'pro' : currentTier;

            // Scroll to the grant form
            document.getElementById('grantRepository').focus();
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');

            // Load data for the tab
            if (tab === 'grant') {
                fetchWaitlist();
                loadAllInstallations();
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }
    </script>
</body>
</html>
