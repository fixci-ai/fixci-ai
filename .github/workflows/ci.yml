name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    name: Lint and Test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Lint code
        run: npm run lint || echo "No lint script found, skipping"
        continue-on-error: true

      - name: Run tests
        run: npm test || echo "No tests found, skipping"
        continue-on-error: true

      - name: Build landing page
        working-directory: apps/landing
        run: |
          npm ci || true
          echo "Landing page validated"

      - name: Build github-app
        working-directory: packages/github-app
        run: |
          npm ci || true
          echo "GitHub app validated"

  validate-schema:
    runs-on: ubuntu-latest
    name: Validate Database Schema

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check migration files
        run: |
          if [ -d "migrations" ]; then
            echo "✓ Migration files found"
            ls -la migrations/
          else
            echo "⚠️  No migrations directory found"
          fi

      - name: Validate SQL syntax
        run: |
          for file in migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              # Basic syntax validation (checks for common SQL keywords)
              if grep -q -E "(CREATE|ALTER|INSERT|UPDATE|DELETE)" "$file"; then
                echo "✓ $file appears valid"
              else
                echo "⚠️  $file may be invalid"
              fi
            fi
          done
